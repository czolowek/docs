% extends "base.html" %}

{% block title %}РЕДАКТИРОВАТЬ {{ person.full_name }} - CYBERPUNK DATABASE{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h1 class="glitch-text">
        <i class="fas fa-user-edit me-3"></i>РЕДАКТИРОВАТЬ ЗАПИСЬ
    </h1>
    <p class="lead text-muted">Обновление данных: {{ person.full_name }}</p>
</div>

<div class="card glow-animation">
    <div class="card-header">
        <h4><i class="fas fa-database me-2"></i>ОБНОВЛЕНИЕ ЗАПИСИ В СИСТЕМЕ</h4>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('edit_person_submit', person_id=person.id) }}">
            
            <!-- Основная информация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-user me-2"></i>ОСНОВНЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="full_name" class="form-label">* ПОЛНОЕ ИМЯ</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" 
                               value="{{ person.full_name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="nickname" class="form-label">НИКНЕЙМ / ПСЕВДОНИМ</label>
                        <input type="text" class="form-control" id="nickname" name="nickname"
                               value="{{ person.nickname or '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="birth_date" class="form-label">ДАТА РОЖДЕНИЯ</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date"
                               value="{{ person.birth_date.strftime('%Y-%m-%d') if person.birth_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="age" class="form-label">ВОЗРАСТ</label>
                        <input type="number" class="form-control" id="age" name="age" min="1" max="120"
                               value="{{ person.age or '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="phone_number" class="form-label">ТЕЛЕФОН</label>
                        <input type="tel" class="form-control" id="phone_number" name="phone_number"
                               value="{{ person.phone_number or '' }}">
                    </div>
                </div>
            </div>

            <!-- Контактная информация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-address-book me-2"></i>КОНТАКТНЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="email" class="form-label">EMAIL</label>
                        <input type="email" class="form-control" id="email" name="email"
                               value="{{ person.email or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="telegram" class="form-label">TELEGRAM</label>
                        <input type="text" class="form-control" id="telegram" name="telegram"
                               value="{{ person.telegram or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="vk_profile" class="form-label">ВКОНТАКТЕ</label>
                        <input type="url" class="form-control" id="vk_profile" name="vk_profile"
                               value="{{ person.vk_profile or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="instagram" class="form-label">INSTAGRAM</label>
                        <input type="text" class="form-control" id="instagram" name="instagram"
                               value="{{ person.instagram or '' }}">
                    </div>
                    <div class="col-12">
                        <label for="other_social" class="form-label">ДРУГИЕ СОЦСЕТИ</label>
                        <textarea class="form-control" id="other_social" name="other_social" rows="2">{{ person.other_social or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Геолокация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-map-marker-alt me-2"></i>ГЕОЛОКАЦИОННЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="current_address" class="form-label">ТЕКУЩИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="current_address" name="current_address"
                               value="{{ person.current_address or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="home_address" class="form-label">ДОМАШНИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="home_address" name="home_address"
                               value="{{ person.home_address or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="work_address" class="form-label">РАБОЧИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="work_address" name="work_address"
                               value="{{ person.work_address or '' }}">
                    </div>
                </div>
            </div>

            <!-- Профессиональная деятельность -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-briefcase me-2"></i>ПРОФЕССИЯ И ОБРАЗОВАНИЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="work_place" class="form-label">МЕСТО РАБОТЫ</label>
                        <input type="text" class="form-control" id="work_place" name="work_place"
                               value="{{ person.work_place or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="job_title" class="form-label">ДОЛЖНОСТЬ</label>
                        <input type="text" class="form-control" id="job_title" name="job_title"
                               value="{{ person.job_title or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="education" class="form-label">ОБРАЗОВАНИЕ</label>
                        <input type="text" class="form-control" id="education" name="education"
                               value="{{ person.education or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="school" class="form-label">ШКОЛА</label>
                        <input type="text" class="form-control" id="school" name="school"
                               value="{{ person.school or '' }}">
                    </div>
                </div>
            </div>

            <!-- Семейные связи -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-users me-2"></i>СЕМЕЙНЫЕ СВЯЗИ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="father_name" class="form-label">ОТЕЦ</label>
                        <input type="text" class="form-control" id="{% extends "base.html" %}

{% block title %}РЕДАКТИРОВАТЬ - {{ person.full_name }} - CYBERPUNK DATABASE{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h1 class="glitch-text">
        <i class="fas fa-user-edit me-3"></i>РЕДАКТИРОВАТЬ ЗАПИСЬ
    </h1>
    <p class="lead text-muted">Обновление данных: {{ person.full_name }}</p>
</div>

<div class="card glow-animation">
    <div class="card-header">
        <h4><i class="fas fa-database me-2"></i>ОБНОВЛЕНИЕ ЗАПИСИ В СИСТЕМЕ</h4>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('edit_person_submit', person_id=person.id) }}">
            
            <!-- Основная информация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-user me-2"></i>ОСНОВНЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="full_name" class="form-label">* ПОЛНОЕ ИМЯ</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" required
                               value="{{ person.full_name or '' }}" placeholder="Иванов Иван Иванович">
                    </div>
                    <div class="col-md-6">
                        <label for="nickname" class="form-label">НИКНЕЙМ / ПСЕВДОНИМ</label>
                        <input type="text" class="form-control" id="nickname" name="nickname"
                               value="{{ person.nickname or '' }}" placeholder="V, Johnny, NetRunner...">
                    </div>
                    <div class="col-md-4">
                        <label for="birth_date" class="form-label">ДАТА РОЖДЕНИЯ</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date"
                               value="{{ person.birth_date.strftime('%Y-%m-%d') if person.birth_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="age" class="form-label">ВОЗРАСТ</label>
                        <input type="number" class="form-control" id="age" name="age" min="1" max="120"
                               value="{{ person.age or '' }}" placeholder="25">
                    </div>
                    <div class="col-md-4">
                        <label for="phone_number" class="form-label">ТЕЛЕФОН</label>
                        <input type="tel" class="form-control" id="phone_number" name="phone_number"
                               value="{{ person.phone_number or '' }}" placeholder="+7 (999) 123-45-67">
                    </div>
                </div>
            </div>

            <!-- Контактная информация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-address-book me-2"></i>КОНТАКТНЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="email" class="form-label">EMAIL</label>
                        <input type="email" class="form-control" id="email" name="email"
                               value="{{ person.email or '' }}" placeholder="user@nightcity.net">
                    </div>
                    <div class="col-md-6">
                        <label for="telegram" class="form-label">TELEGRAM</label>
                        <input type="text" class="form-control" id="telegram" name="telegram"
                               value="{{ person.telegram or '' }}" placeholder="@username или t.me/username">
                    </div>
                    <div class="col-md-6">
                        <label for="vk_profile" class="form-label">ВКОНТАКТЕ</label>
                        <input type="url" class="form-control" id="vk_profile" name="vk_profile"
                               value="{{ person.vk_profile or '' }}" placeholder="https://vk.com/id123456">
                    </div>
                    <div class="col-md-6">
                        <label for="instagram" class="form-label">INSTAGRAM</label>
                        <input type="text" class="form-control" id="instagram" name="instagram"
                               value="{{ person.instagram or '' }}" placeholder="@username или ссылка">
                    </div>
                    <div class="col-12">
                        <label for="other_social" class="form-label">ДРУГИЕ СОЦСЕТИ</label>
                        <textarea class="form-control" id="other_social" name="other_social" rows="2"
                                  placeholder="TikTok, YouTube, Discord и другие профили">{{ person.other_social or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Геолокация -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-map-marker-alt me-2"></i>ГЕОЛОКАЦИОННЫЕ ДАННЫЕ
                </h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="current_address" class="form-label">ТЕКУЩИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="current_address" name="current_address"
                               value="{{ person.current_address or '' }}" placeholder="г. Night City, район Watson, ул. Корпорации, д. 10">
                    </div>
                    <div class="col-md-6">
                        <label for="home_address" class="form-label">ДОМАШНИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="home_address" name="home_address"
                               value="{{ person.home_address or '' }}" placeholder="Если отличается от текущего">
                    </div>
                    <div class="col-md-6">
                        <label for="work_address" class="form-label">РАБОЧИЙ АДРЕС</label>
                        <input type="text" class="form-control" id="work_address" name="work_address"
                               value="{{ person.work_address or '' }}" placeholder="Место работы/учебы">
                    </div>
                </div>
            </div>

            <!-- Профессиональная деятельность -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-briefcase me-2"></i>ПРОФЕССИЯ И ОБРАЗОВАНИЕ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="work_place" class="form-label">МЕСТО РАБОТЫ</label>
                        <input type="text" class="form-control" id="work_place" name="work_place"
                               value="{{ person.work_place or '' }}" placeholder="Arasaka Corp, Militech, Solo...">
                    </div>
                    <div class="col-md-6">
                        <label for="job_title" class="form-label">ДОЛЖНОСТЬ</label>
                        <input type="text" class="form-control" id="job_title" name="job_title"
                               value="{{ person.job_title or '' }}" placeholder="Netrunner, Corpo, Nomad...">
                    </div>
                    <div class="col-md-6">
                        <label for="education" class="form-label">ОБРАЗОВАНИЕ</label>
                        <input type="text" class="form-control" id="education" name="education"
                               value="{{ person.education or '' }}" placeholder="Night City University, Corp Academy...">
                    </div>
                    <div class="col-md-6">
                        <label for="school" class="form-label">ШКОЛА</label>
                        <input type="text" class="form-control" id="school" name="school"
                               value="{{ person.school or '' }}" placeholder="Школа №2077, Watson District">
                    </div>
                </div>
            </div>

            <!-- Семейные связи -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-users me-2"></i>СЕМЕЙНЫЕ СВЯЗИ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="father_name" class="form-label">ОТЕЦ</label>
                        <input type="text" class="form-control" id="father_name" name="father_name"
                               value="{{ person.father_name or '' }}" placeholder="ФИО отца">
                    </div>
                    <div class="col-md-6">
                        <label for="mother_name" class="form-label">МАТЬ</label>
                        <input type="text" class="form-control" id="mother_name" name="mother_name"
                               value="{{ person.mother_name or '' }}" placeholder="ФИО матери">
                    </div>
                    <div class="col-12">
                        <label for="siblings" class="form-label">БРАТЬЯ/СЕСТРЫ</label>
                        <textarea class="form-control" id="siblings" name="siblings" rows="2"
                                  placeholder="Информация о братьях и сестрах">{{ person.siblings or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Дополнительные данные -->
            <div class="form-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-info-circle me-2"></i>ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="car_info" class="form-label">ТРАНСПОРТ</label>
                        <input type="text" class="form-control" id="car_info" name="car_info"
                               value="{{ person.car_info or '' }}" placeholder="Quadra V-Tech, Rayfield Caliburn, мотоцикл...">
                    </div>
                    <div class="col-md-6">
                        <label for="photos" class="form-label">ФОТО (ССЫЛКИ)</label>
                        <input type="text" class="form-control" id="photos" name="photos"
                               value="{{ person.photos or '' }}" placeholder="Ссылки на фотографии через запятую">
                    </div>
                    <div class="col-md-6">
                        <label for="hobbies" class="form-label">ХОББИ/ИНТЕРЕСЫ</label>
                        <textarea class="form-control" id="hobbies" name="hobbies" rows="3"
                                  placeholder="Браindance, киберспорт, модификации...">{{ person.hobbies or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="additional_info" class="form-label">ПРОЧИЕ ДАННЫЕ</label>
                        <textarea class="form-control" id="additional_info" name="additional_info" rows="3"
                                  placeholder="Любая дополнительная информация, заметки, связи">{{ person.additional_info or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Кнопки управления -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-save me-2"></i>ОБНОВИТЬ ЗАПИСЬ
                </button>
                <a href="{{ url_for('view_person', person_id=person.id) }}" class="btn btn-outline-light btn-lg me-3">
                    <i class="fas fa-eye me-2"></i>ПРОСМОТР
                </a>
                <a href="{{ url_for('search') }}" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-times me-2"></i>ОТМЕНА
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Change History Info -->
<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-history me-2"></i>ИСТОРИЯ ИЗМЕНЕНИЙ</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="info-item">
                    <span class="label">СОЗДАНА:</span>
                    <span class="value">{{ person.created_at.strftime('%d.%m.%Y в %H:%M') if person.created_at else 'Неизвестно' }}</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-item">
                    <span class="label">ПОСЛЕДНЕЕ ОБНОВЛЕНИЕ:</span>
                    <span class="value">{{ person.updated_at.strftime('%d.%m.%Y в %H:%M') if person.updated_at else 'Неизвестно' }}</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-item">
                    <span class="label">ДОБАВИЛ:</span>
                    <span class="value">{{ person.added_by or 'Неизвестно' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-format phone number
    const phoneInput = document.getElementById('phone_number');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, '+7 ($1) $2-$3-$4');
                }
                this.value = value;
            }
        });
    }
    
    // Auto-format Telegram username
    const telegramInput = document.getElementById('telegram');
    if (telegramInput) {
        telegramInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value && !value.startsWith('@') && !value.startsWith('t.me/')) {
                this.value = '@' + value;
            }
        });
    }
    
    // Auto-format Instagram username
    const instagramInput = document.getElementById('instagram');
    if (instagramInput) {
        instagramInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value && !value.startsWith('@') && !value.startsWith('http')) {
                this.value = '@' + value;
            }
        });
    }
    
    // Form validation enhancement
    const form = document.querySelector('form');
    if (form) {
        // Track changes
        const originalData = new FormData(form);
        let hasChanges = false;
        
        // Monitor form changes
        form.addEventListener('input', function() {
            hasChanges = true;
        });
        
        // Warning before leaving with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?';
            }
        });
        
        form.addEventListener('submit', function(e) {
            const fullName = document.getElementById('full_name').value.trim();
            if (!fullName) {
                e.preventDefault();
                alert('Введите полное имя для сохранения записи!');
                document.getElementById('full_name').focus();
                return false;
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ОБНОВЛЕНИЕ...';
            submitBtn.disabled = true;
            
            // Remove beforeunload warning
            hasChanges = false;
        });
    }
    
    // Add entrance animations to form sections
    const sections = document.querySelectorAll('.form-section');
    sections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateX(-30px)';
        
        setTimeout(() => {
            section.style.transition = 'all 0.6s ease';
            section.style.opacity = '1';
            section.style.transform = 'translateX(0)';
        }, index * 100);
    });
    
    // Enhanced field highlighting
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.02)';
            this.parentElement.style.transition = 'transform 0.2s ease';
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
        });
    });
});
</script>
{% endblock %}
